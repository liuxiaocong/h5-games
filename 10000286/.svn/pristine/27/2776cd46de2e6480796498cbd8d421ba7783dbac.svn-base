/**
Details and examples:
http://thinkpixellab.com/pxloader/
The MIT License
Copyright (c) 2012 Pixel Lab
**/

function PxLoader(c){c=c||{};if(c.statusInterval==null){c.statusInterval=5000}if(c.loggingDelay==null){c.loggingDelay=20*1000}if(c.noProgressTimeout==null){c.noProgressTimeout=Infinity}var f=[],a=[],l,b=+new Date;var i={QUEUED:0,WAITING:1,LOADED:2,ERROR:3,TIMEOUT:4};var j=function(m){if(m==null){return[]}if(Array.isArray(m)){return m}return[m]};this.add=function(m){m.tags=new PxLoaderTags(m.tags);if(m.priority==null){m.priority=Infinity}f.push({resource:m,state:i.QUEUED})};this.addProgressListener=function(n,m){a.push({callback:n,tags:new PxLoaderTags(m)})};this.addCompletionListener=function(n,m){a.push({tags:new PxLoaderTags(m),callback:function(o){if(o.completedCount===o.totalCount){n()}}})};var h=function(m){m=j(m);var n=function(r){var s=r.resource,q=Infinity;for(var p=0;p<s.tags.length;p++){for(var o=0;o<Math.min(m.length,q);o++){if(s.tags[p]==m[o]&&o<q){q=o;if(q===0){break}}if(q===0){break}}}return q};return function(p,o){var r=n(p),q=n(o);if(r<q){return -1}if(r>q){return 1}if(p.priority<o.priority){return -1}if(p.priority>o.priority){return 1}return 0}};this.start=function(n){l=+new Date;var o=h(n);f.sort(o);for(var p=0,m=f.length;p<m;p++){var q=f[p];q.status=i.WAITING;q.resource.start(this)}setTimeout(d,100)};var d=function(){var q=false,r=(+new Date)-b,n=(r>=c.noProgressTimeout),o=(r>=c.loggingDelay);for(var p=0,m=f.length;p<m;p++){var s=f[p];if(s.status!==i.WAITING){continue}s.resource.checkStatus();if(s.status===i.WAITING){if(n){s.resource.onTimeout()}else{q=true}}}if(o&&q){e()}if(q){setTimeout(d,c.statusInterval)}};this.isBusy=function(){for(var n=0,m=f.length;n<m;n++){if(f[n].status===i.QUEUED||f[n].status===i.WAITING){return true}}return false};var k=function(o,u){var t=null;for(var p=0,s=f.length;p<s;p++){if(f[p].resource===o){t=f[p];break}}if(t==null||t.status!==i.WAITING){return}t.status=u;b=+new Date;var m=o.tags.length;for(var p=0,r=a.length;p<r;p++){var n=a[p],q;if(n.tags.length===0){q=true}else{q=o.tags.contains(n.tags)}if(q){g(t,n)}}};this.onLoad=function(m){k(m,i.LOADED)};this.onError=function(m){k(m,i.ERROR)};this.onTimeout=function(m){k(m,i.TIMEOUT)};var g=function(n,t){var q=0,s=0;for(var p=0,m=f.length;p<m;p++){var r=f[p],o=false;if(t.tags.length===0){o=true}else{o=r.resource.tags.contains(t.tags)}if(o){s++;if(r.status===i.LOADED||r.status===i.ERROR||r.status===i.TIMEOUT){q++}}}t.callback({resource:n.resource,loaded:(n.status===i.LOADED),error:(n.status===i.ERROR),timeout:(n.status===i.TIMEOUT),completedCount:q,totalCount:s})};var e=this.log=function(p){if(!window.console){return}var o=Math.round((+new Date-l)/1000);window.console.log("PxLoader elapsed: "+o+" sec");for(var n=0,m=f.length;n<m;n++){var r=f[n];if(!p&&r.status!==i.WAITING){continue}var q="PxLoader: #"+n+" "+r.resource.getName();switch(r.status){case i.QUEUED:q+=" (Not Started)";break;case i.WAITING:q+=" (Waiting)";break;case i.LOADED:q+=" (Loaded)";break;case i.ERROR:q+=" (Error)";break;case i.TIMEOUT:q+=" (Timeout)";break}if(r.resource.tags.length>0){q+=" Tags: ["+r.resource.tags.join(",")+"]"}window.console.log(q)}}}function PxLoaderTags(a){this.array=[];this.object={};this.value=null;this.length=0;if(a!==null&&a!==undefined){if(Array.isArray(a)){this.array=a}else{if(typeof a==="object"){for(var c in a){this.array.push(c)}}else{this.array.push(a);this.value=a}}this.length=this.array.length;for(var b=0;b<this.length;b++){this.object[this.array[b]]=true}}this.contains=function(d){if(this.length===0||d.length===0){return false}else{if(this.length===1){if(d.length===1){return this.value===d.value}else{return d.object.hasOwnProperty(this.value)}}else{if(d.length<this.length){return d.contains(this)}else{for(var e in this.object){if(d.object[e]){return true}}return false}}}}}if(!Array.isArray){Array.isArray=function(a){return Object.prototype.toString.call(a)=="[object Array]"}};